# Go-CRUD RESTful API 模型操作流程

以下是一个完整的 Go-CRUD RESTful API 中对模型进行增删改查（CRUD）操作的标准流程

## 查询操作

### 单个查询（完成）

1. 解析路径参数
   1. 获取资源 ID
   2. 如果 ID 为 0，返回 `ErrReadInvalidID` 错误
2. 解析查询参数
   1. 获取 `fields`（可选字段）
   2. 获取 `expand`（关联数据展开）
3. 获取模型元数据
   1. 通过模型表名获取模型元数据
   2. 如果元数据不存在，返回 `ErrReadGeneral` 错误
4. 执行前置钩子
   1. 如果配置了前置钩子函数，执行它
   2. 可用于权限检查、前置处理等
   3. 如果钩子执行失败，返回 `ErrReadHookFailure` 错误
5. 字段选择与验证
   1. 解析 `fields` 参数
   2. 验证每个请求字段是否在 `AllowGetFields` 中
   3. 如果请求了不允许获取的字段，返回 `ErrReadInvalidField` 错误
   4. 如果未指定字段，默认返回所有允许获取的字段
6. 数据库查询
   1. 构建按 ID 查询的条件
   2. 选择指定的字段
   3. 执行查询
   4. 如果查询失败，返回 `ErrDBQuery` 错误
   5. 如果记录不存在，返回 `ErrReadNotFound` 错误
7. 关联数据展开
   1. 解析 `expand` 参数
   2. 检查关联关系是否存在
   3. 如果关联表不存在，返回 `ErrReadRelation` 错误
   4. 根据外键查询关联表数据
   5. 将关联数据插入到查询结果中
8. 执行后置钩子
   1. 如果配置了后置钩子函数，执行它
   2. 可用于数据后处理、日志记录等
   3. 如果钩子执行失败，返回 `ErrReadHookFailure` 错误
9. 返回结果
   1. 返回 HTTP 200 OK 状态码
   2. 返回查询到的资源数据

### 列表查询（完成）

1. 解析分页参数
   1. 获取 `page`（页码），默认为 1
   2. 获取 `per_page`（每页记录数），默认为 10，最大 100
   3. 调整页码和每页记录数到合理范围
2. 解析查询参数
   1. 获取 `fields`（可选字段）
   2. 获取 `expand`（关联数据展开）
   3. 获取 `sort_by`（排序字段）
   4. 获取 `sort_order`（排序方向）
3. 获取模型元数据
   1. 通过模型表名获取模型元数据
   2. 如果元数据不存在，返回 `ErrReadGeneral` 错误
4. 执行前置钩子
   1. 如果配置了前置钩子函数，执行它
   2. 可用于权限检查、前置处理等
   3. 如果钩子执行失败，返回 `ErrReadHookFailure` 错误
5. 字段选择与验证
   1. 解析 `fields` 参数
   2. 验证每个请求字段是否在 `AllowGetFields` 中
   3. 如果请求了不允许获取的字段，返回 `ErrReadInvalidField` 错误
   4. 如果未指定字段，默认返回所有允许获取的字段
6. 构建数据库查询
   1. 处理过滤条件（支持精确、模糊、开头、结尾匹配）
   2. 处理排序条件
   3. 如果排序字段不在 `AllowGetFields` 中，返回 `ErrReadSort` 错误
   4. 应用分页（offset 和 limit）
7. 查询总记录数
   1. 计算符合条件的总记录数
   2. 如果查询总数失败，返回 `ErrDBQuery` 错误
8. 执行查询
   1. 查询符合条件的记录
   2. 选择指定的字段
   3. 如果查询失败，返回 `ErrDBQuery` 错误
9. 关联数据展开
   1. 解析 `expand` 参数
   2. 检查关联关系是否存在
   3. 如果关联表不存在，返回 `ErrReadRelation` 错误
   4. 根据外键查询关联表数据
   5. 将关联数据插入到每条查询结果中
10. 执行后置钩子
    1. 如果配置了后置钩子函数，执行它
    2. 可用于数据后处理、日志记录等
    3. 如果钩子执行失败，返回 `ErrReadHookFailure` 错误
11. 返回结果
    1. 返回 HTTP 200 OK 状态码
    2. 返回查询到的资源列表
    3. 包含分页信息（总记录数、当前页、总页数等）

## 创建操作

### 单个创建（完成）

1. **获取模型实例与设置上下文**
   1. 创建新的模型的对象实例
   2. 设置上下文为"create"，支持条件性验证
2. **绑定请求数据到模型**
   1. 使用ShouldBindJSON解析请求体
   2. 映射到模型结构并进行基础验证
   3. 验证失败返回参数解析错误
3. **检查唯一性约束**
   1. 根据业务唯一字段检查是否已存在
   2. 已存在则返回`ErrCreateDuplicate`错误
   3. 检查过程出错则返回`ErrCreateGeneral`错误
4. **执行前置钩子**
   1. 如果配置了前置钩子函数则执行
   2. 可在钩子中实现权限检查、业务规则验证等
   3. 钩子执行失败则返回`ErrCreateHookFailure`错误
5. **处理事务**
   1. 如果启用了事务，开始一个新事务
   2. 设置事务回滚/提交的延迟函数
   3. 事务开启失败则返回`ErrDBTransaction`错误）
6. **执行创建操作**
   1. 使用GORM的Create方法将模型保存到数据库
   2. 创建失败则返回`ErrCreateGeneral`错误并回滚事务
7. **执行后置钩子**
   1. 如果配置了后置钩子函数则执行
   2. 可在钩子中处理关联数据、发送通知等
   3. 钩子执行失败则返回`ErrCreateHookFailure`错误并回滚事务
8. **返回结果**
   1. 提交事务（如果启用）
   2. 返回HTTP 201 Created状态码
   3. 返回创建成功的响应

### 批量创建

1. **绑定请求数据到模型列表**
   1. 解析请求体中的数组数据
   2. 映射到模型结构列表
2. **检查唯一性约束**
   1. 检查列表内部是否有重复项
   2. 检查与数据库中现有数据是否冲突
3. **校验请求数据**
   1. 对列表中每个项目进行字段验证
   2. 设置默认值（如需要）
4. **权限检查**
   1. 验证用户是否有批量创建权限
5. **执行创建操作**
   1. 开启数据库事务
   2. 循环创建每个资源
      1. 设置审计字段
      2. 保存到数据库
   3. 如有错误则回滚事务
   4. 成功则提交事务
   5. 记录操作日志
6. **返回结果**
   1. 返回 201 Created 状态码
   2. 返回创建的资源列表或摘要信息

## 更新操作

### 完整更新（PUT）

1. **解析路径参数**
   1. 获取资源 ID
2. **检查资源是否存在**
   1. 不存在则返回 404 错误
3. **绑定请求数据到模型**
   1. 解析请求体
   2. 映射到模型结构
4. **权限检查**
   1. 验证用户是否有权限更新该资源
5. **校验请求数据**
   1. 检查所有必填字段是否提供
   2. 验证字段格式和值范围
6. **执行更新操作**
   1. 设置更新时间、更新者等审计字段
   2. 保存到数据库
   3. 记录操作日志
7. **返回结果**
   1. 返回 200 OK 状态码
   2. 返回更新后的资源数据

### 部分更新（PATCH）(完成)

1. **解析路径参数**
   1. 获取资源 ID（从URL路径参数中）
   1. 如果 ID 为空，返回 `ErrUpdateMissingField` 错误
2. **检查资源是否存在**
   1. 使用 ID 从数据库查询现有资源
   2. 如果不存在，返回 `ErrUpdateNotFound` 错误（404）
   3. 如果查询出错，返回 `ErrDBQuery` 错误
3. **绑定请求数据**
   1. 解析请求体 JSON 到 `map[string]interface{}`
   2. 如果解析失败，返回 `ErrUpdateInvalidField` 错误
   3. 如果请求体为空，返回 `ErrUpdateMissingField` 错误
4. **验证可更新字段**
   1. 获取模型元数据，包含允许部分更新的字段列表
   2. 如果无法获取元数据，返回 `ErrInternal` 错误
   3. 如果模型不支持部分更新（字段列表为空），返回 `ErrUpdateInvalidField` 错误
   4. 检查请求中的每个字段是否在允许更新的字段列表中
   5. 如果有不允许更新的字段，返回 `ErrUpdateInvalidField` 错误
   6. 如果没有有效字段可以更新，返回 `ErrUpdateInvalidField` 错误
5. **执行前置钩子**
   1. 如果设置了前置钩子函数，使用有效字段映射调用它
   2. 如果钩子执行失败，返回 `ErrUpdateHookFailure` 错误
6. **处理事务**
   1. 如果启用了事务，开始一个新事务
   2. 设置事务回滚/提交的延迟函数
7. **执行更新操作**
   1. 使用有效字段映射更新数据库中的资源
   2. 如果更新失败，返回 `ErrUpdateGeneral` 错误
   3. 处理没有行被更新的情况（可能是因为值没有变化）
8. **获取更新后的资源**
   1. 从数据库查询更新后的完整资源
   2. 如果查询失败，返回 `ErrReadGeneral` 错误
9. **执行后置钩子**
   1. 如果设置了后置钩子函数，使用有效字段映射调用它
   2. 如果钩子执行失败，返回 `ErrUpdateHookFailure` 错误

10. **返回结果**
    1. 返回 HTTP 200 OK 状态码
    2. 返回更新后的完整资源数据
    3. 可选：包含成功消息

### 批量更新

1. **绑定请求数据**
   1. 解析请求体中的批量更新数据
2. **检查资源是否存在**
   1. 验证所有待更新资源是否存在
   2. 如有不存在的资源，可选择跳过或返回错误
3. **权限检查**
   1. 验证用户是否有批量更新权限
   2. 验证用户对每个资源的更新权限
4. **执行更新操作**
   1. 开启数据库事务
   2. 循环更新每个资源
      1. 验证和处理每个资源的数据
      2. 设置审计字段
      3. 保存到数据库
   3. 如有错误则回滚事务
   4. 成功则提交事务
   5. 记录操作日志
5. **返回结果**
   1. 返回 200 OK 状态码
   2. 返回更新结果摘要（成功数量、失败数量等）

## 删除操作

### 单个删除（完成）

1. **解析路径参数**
   1. 获取资源 ID
   2. 如果 ID 为空，返回错误（ErrDeleteMissingField）
2. **检查资源是否存在**
   1. 通过 ID 查询数据库
   2. 如果不存在，返回 404 错误（ErrDeleteNotFound）
   3. 如果查询出错，返回数据库查询错误（ErrDBQuery）
3. **执行前置钩子**
   1. 如果设置了前置钩子函数，执行它
   2. 前置钩子可用于权限检查和业务规则验证
   3. 如果钩子执行失败，返回错误（ErrDeleteHookFailure）
4. **处理事务**
   1. 如果启用了事务，开启事务
   2. 如果开启事务失败，返回错误（ErrDBTransaction）
   3. 设置延迟函数处理事务的提交或回滚
5. **执行删除操作**
   1. 执行软删除操作（通过 GORM 的 Delete 方法）
   2. 如果删除操作失败，返回错误（ErrDeleteGeneral）
   3. 如果删除未影响任何记录，返回错误（ErrDeleteGeneral）
6. **执行后置钩子**
   1. 如果设置了后置钩子函数，执行它
   2. 后置钩子可用于清理相关资源、发送通知、记录操作日志等
   3. 如果钩子执行失败，返回错误（ErrDeleteHookFailure）

7. **返回结果**
   1. 返回 204 No Content 状态码
   2. 不返回响应体内容

### 批量删除

1. **解析请求参数**
   1. 获取要删除的资源 ID 列表
2. **检查资源是否存在**
   1. 验证所有待删除资源是否存在
3. **权限检查**
   1. 验证用户是否有批量删除权限
   2. 验证用户对每个资源的删除权限
4. **业务规则验证**
   1. 检查每个资源的依赖关系和状态
5. **执行删除操作**
   1. 开启数据库事务
   2. 循环删除每个资源
   3. 如有错误则回滚事务
   4. 成功则提交事务
   5. 记录操作日志
6. **返回结果**
   1. 返回 200 OK 状态码
   2. 返回删除结果摘要（成功数量、失败数量等）
